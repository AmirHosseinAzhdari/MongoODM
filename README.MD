### <div align="center">April 20 2021</div>

# Base Structure for Microservices

This is the base structure defined for microservices. It is constructed in 3 categorise. which are in base folder.

1. Database Management (db folder)

2. Message broker Management (rabbit folder)

3. API Views (rf views)
***
**There are two files in the base folder as well, aes is the AES library and minor_health_check is used for health check of the system.**
***
## 1. Database Management (db folder)

It is based on  **[Django](https://www.djangoproject.com/)** project,
**[Mongo Frames](https://github.com/GetmeUK/MongoFrames)** project and
**[Motor](https://pypi.org/project/motor/)**.

It consists of 3 subpackages.

### fields

It uses benefits of **[Django](https://www.djangoproject.com/)** fields validation and definition. They are modified,
and some new fields are added. to manage **[MongoDB](https://www.mongodb.com/)** fields.

These fields include:

- ```ObjectIDField: Field to manage bson ObjectId```

- ```EmbeddedField: Field to manage embedded fields```

- ```ArrayField: Field to manage array objects```

- ```ForeignFrame: Since mongo does not support relations, child tables are identified in this field.```

### frames

This project used the base idea of **[Django](https://www.djangoproject.com/)** Models and
**[Mongo Frames](https://github.com/GetmeUK/MongoFrames)** frames. Though
the **[Mongo Frames](https://github.com/GetmeUK/MongoFrames)** has been edited a lot, and it is barely recognizable.

The serialization and validation features has been added to it. Due to the migration to async django, this section
discontinued.

### frames_motor

In the continues of the frames project, and migration to async python frames motor completed the frames project.

The functionality of Frames is elaborated in the following:

#### Variables

##### Private Variables

- _meta : Dictionary holding the set of db keys, and their data type.

- _update_field: set of keys update by the user, used for update purpose to send fewer data to db

  It is generated in the initiation of the class and filled based on field types globally defined in the class.
- _child_frames: List of Foreign Frames

##### Public Variables

- include: List of variables to be included in the json data
- exclude: List of variables to be included in the json data
- errors: List of errors generated by validation
- additional: List of fields that are added in the projection of aggregate pipeline

#### Functions

##### Private Functions

- _get_document_value: converts the value to mongo desired input

- _get_document: returns the document to be inserted in the database

- _json_safe: converts data to json parsable

###### Private Functions just for Frame

- _get_parent_key: returns the key for the parent in the child for deletion

- _cascade: simulates the CASCADE in relational database

- _restrict: simulates the RESTRICT in relational database

- _set_null: simulates the SET_NULL in relational database

- _set_default: simulates the SET_DEFAULT in relational database

##### Public Functions

- set_items: Inputs a dictionary and sets the fields to those values.

- is_valid: validates the input data

- clean: same as is_valid, but used in EmbeddedField

- clear_update_fields: clears the private _update_field

- to_json_type: converts the frame to json data structure

###### Public Functions just for Frame

- save: saves the edited data in the database that is either update or insert based on frame ```_id```

- insert: inserts frame data directly into database

- update: updates the frame data directly into database

- delete: deletes the data based on frame ```_id```

- pull: pulls from array object in the data

- push: pushes the data into array object in the data

- raw_update_one: update data with custom query and data

- raw_update_many: update data with custom query and data

- one: Return data findOne by query

- one_json: returns data in json type

- many: Return data find by query

- many_json: Return data in json format found by query

- aggregate: Return aggregate data

- aggregate_json: Return aggregate data in json format

- counts: Return count of object by aggregate

- insert_many: insert many documents

- delete_many: delete many by key and id

- raw_delete_many: direct delete many with query to database

- raw_delete_one: direct delete one with query to database

- reload: reload the data

- get_collection: Get the collection

- get_db: Get the database
***
## 2. Message broker Management (rabbit folder)

This package handles the communications through message broker(MB), that is **[RabbitMQ](https://www.rabbitmq.com/)**
for now.

It has 3 functionalities:

- publish: Publishes a message in the MB with routing key

- consume: Consumes messages sent through MB

- rpc: Make an RPC call, meaning publish and consume in rpc queue. To make RPC singleton, an instance is created in the
  package init.
***
## 3. API Views (rf views)

Since **[DRF](https://www.django-rest-framework.org/)** was not compatible with async views of django, with made
modifications to some of its functionalities to make it compatible with it.

Also a Response class is made based on Django JsonResponse which returns unified response to the front end.

It includes:

- result: Boolean field for the result of op
- status_code: A status code sent to developer to handle ops if multiple are required.
- messages: Messages sent to front end to display, consists of ```general``` whis is the message to be showed in the
  popup. and ```validations``` which is consists of validation errors on fields.
  
- data: The data returned to front-end. 
